# üîê Crypto Payments (TRC20 USDT) - –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–ú–æ–¥—É–ª—å –¥–ª—è –ø—Ä–∏—ë–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π –≤ USDT TRC20 –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —à–ª—é–∑–æ–≤.

## üõ°Ô∏è –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- **–ü–æ–ª–Ω–∞—è –∞–Ω–æ–Ω–∏–º–Ω–æ—Å—Ç—å** ‚Äî –Ω–µ—Ç KYC, –Ω–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Ç—Ä–µ—Ç—å–∏–º–∏ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏
- **–ü—Ä—è–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–ª–æ–∫—á–µ–π–Ω–æ–º** —á–µ—Ä–µ–∑ TronGrid API
- **–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞** ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–≤—è–∑–∞—Ç—å –ø–ª–∞—Ç–µ–∂–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π
- **–®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π** ‚Äî AES-256 (Fernet)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –≤—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **Callback —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

```bash
pip install tronpy ecdsa base58 cryptography requests
```

### 2. –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Python:

```python
from cryptography.fernet import Fernet
print(Fernet.generate_key().decode())
```

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∫–ª—é—á ‚Äî –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –∫–æ—à–µ–ª—å–∫–æ–≤.

### 3. –ü–æ–ª—É—á–∏—Ç–µ TronGrid API –∫–ª—é—á

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [https://www.trongrid.io/](https://www.trongrid.io/)
2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø–æ—á—Ç—É)
3. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π API –∫–ª—é—á –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–ª—é—á

### 4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞ –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:

```bash
# TronGrid API –∫–ª—é—á (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
TRONGRID_API_KEY=–≤–∞—à-api-–∫–ª—é—á-–æ—Ç-trongrid

# –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
CRYPTO_ENCRYPTION_KEY=–≤–∞—à-fernet-–∫–ª—é—á-–∏–∑-—à–∞–≥–∞-2

# –°–µ—Ç—å: mainnet (—Ä–µ–∞–ª—å–Ω–∞—è) –∏–ª–∏ shasta (—Ç–µ—Å—Ç–æ–≤–∞—è)
TRON_NETWORK=mainnet
```

**Windows PowerShell:**
```powershell
$env:TRONGRID_API_KEY = "–≤–∞—à-api-–∫–ª—é—á"
$env:CRYPTO_ENCRYPTION_KEY = "–≤–∞—à-fernet-–∫–ª—é—á"
$env:TRON_NETWORK = "mainnet"
```

**Linux/Mac:**
```bash
export TRONGRID_API_KEY="–≤–∞—à-api-–∫–ª—é—á"
export CRYPTO_ENCRYPTION_KEY="–≤–∞—à-fernet-–∫–ª—é—á"
export TRON_NETWORK="mainnet"
```

### 5. –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏

```bash
cd backend
python manage.py makemigrations crypto_payments
python manage.py migrate
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç—ë–∂ (API)

```bash
POST /api/v1/crypto/payment/create
Content-Type: application/json

{
    "amount": "50.00",
    "currency": "USDT",
    "metadata": {"order_id": "12345"},
    "callback_url": "https://yoursite.com/webhook"
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "success": true,
    "payment": {
        "payment_id": "A1B2C3D4",
        "address": "TXyz123...abc",
        "amount": "50.00",
        "currency": "USDT",
        "expires_at": "2025-12-10T15:30:00Z",
        "status": "pending"
    }
}
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞

```bash
GET /api/v1/crypto/payment/A1B2C3D4/status
```

**–û—Ç–≤–µ—Ç:**
```json
{
    "success": true,
    "payment": {
        "payment_id": "A1B2C3D4",
        "status": "completed",
        "address": "TXyz123...abc",
        "currency": "USDT",
        "amount_expected": "50.00",
        "amount_received": "50.00",
        "confirmations": 21,
        "tx_hash": "abc123...",
        "expires_at": "2025-12-10T15:30:00Z"
    }
}
```

### –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ:

```bash
python manage.py monitor_payments
```

–ò–ª–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º:

```bash
python manage.py monitor_payments --interval=30
```

---

## üìã API Endpoints

| –ú–µ—Ç–æ–¥ | URL | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|-----|----------|
| POST | `/api/v1/crypto/payment/create` | –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂ |
| GET | `/api/v1/crypto/payment/<id>/status` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ |
| GET | `/api/v1/crypto/payment/<id>/detail` | –î–µ—Ç–∞–ª–∏ –ø–ª–∞—Ç–µ–∂–∞ —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ |
| GET | `/api/v1/crypto/payments/my` | –ü–ª–∞—Ç–µ–∂–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (auth) |
| POST | `/api/v1/crypto/verify-address` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∞–¥—Ä–µ—Å–∞ |
| GET | `/api/v1/crypto/balance/<address>` | –ë–∞–ª–∞–Ω—Å USDT –Ω–∞ –∞–¥—Ä–µ—Å–µ |

---

## üîÑ –°—Ç–∞—Ç—É—Å—ã –ø–ª–∞—Ç–µ–∂–µ–π

| –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|----------|
| `pending` | –û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã |
| `confirming` | –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –∂–¥—ë–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π |
| `completed` | –ü–ª–∞—Ç—ë–∂ –∑–∞–≤–µ—Ä—à—ë–Ω (‚â•19 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π) |
| `expired` | –í—Ä–µ–º—è –Ω–∞ –æ–ø–ª–∞—Ç—É –∏—Å—Ç–µ–∫–ª–æ (60 –º–∏–Ω—É—Ç) |
| `failed` | –û—à–∏–±–∫–∞ |

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏

- –í—Å–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è AES-256 (Fernet) –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ –ë–î
- –ö–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –ù–ï –≤ –∫–æ–¥–µ
- –ö–∞–∂–¥—ã–π –ø–ª–∞—Ç—ë–∂ –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

1. **–ù–ò–ö–û–ì–î–ê** –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ `.env` —Ñ–∞–π–ª –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ API –∫–ª—é—á–∏ –¥–ª—è dev/prod
3. –†–µ–≥—É–ª—è—Ä–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –∞–¥—Ä–µ—Å–æ–≤ –Ω–∞ —Ö–æ–ª–æ–¥–Ω—ã–π –∫–æ—à–µ–ª—ë–∫
4. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ HTTPS –¥–ª—è callback URL
5. –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∞–¥–º–∏–Ω–∫–µ Django

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–µ—Ç—å **Shasta** (—Ç–µ—Å—Ç–Ω–µ—Ç TRON):

```bash
TRON_NETWORK=shasta
```

–ü–æ–ª—É—á–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ TRX/USDT: [Shasta Faucet](https://www.trongrid.io/faucet)

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
crypto_payments/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ admin.py           # –ê–¥–º–∏–Ω–∫–∞ Django
‚îú‚îÄ‚îÄ apps.py
‚îú‚îÄ‚îÄ models.py          # –ú–æ–¥–µ–ª–∏: CryptoPayment, PaymentAddress, etc.
‚îú‚îÄ‚îÄ serializers.py     # DRF —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã
‚îú‚îÄ‚îÄ services.py        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞, TronGrid API
‚îú‚îÄ‚îÄ urls.py            # URL –º–∞—Ä—à—Ä—É—Ç—ã
‚îú‚îÄ‚îÄ views.py           # API endpoints
‚îú‚îÄ‚îÄ management/
‚îÇ   ‚îî‚îÄ‚îÄ commands/
‚îÇ       ‚îî‚îÄ‚îÄ monitor_payments.py  # –ö–æ–º–∞–Ω–¥–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
‚îî‚îÄ‚îÄ migrations/
```

---

## ‚ùì FAQ

**Q: –ù—É–∂–µ–Ω –ª–∏ –º–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π TRON –∫–æ—à–µ–ª—ë–∫?**
A: –ù–µ—Ç. –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.

**Q: –ö–∞–∫ –≤—ã–≤–µ—Å—Ç–∏ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞?**
A: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–ª—é—á–∏ –∏–∑ –ë–î (—Ä–∞—Å—à–∏—Ñ—Ä—É–π—Ç–µ –∏—Ö) –¥–ª—è –ø–æ–¥–ø–∏—Å–∞–Ω–∏—è –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ TronPy –∏–ª–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –≤ TronLink.

**Q: –°–∫–æ–ª—å–∫–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å?**
A: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 19 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π (~1 –º–∏–Ω—É—Ç–∞). –ú–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ `services.py` ‚Üí `MIN_CONFIRMATIONS`.

**Q: –ö–∞–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è?**
A: –ö–æ–º–∏—Å—Å–∏—è —Å–µ—Ç–∏ TRON (~1 TRX –∑–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é). –ù–∏–∫–∞–∫–∏—Ö –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–∏—Å—Å–∏–π.

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
2. TronGrid API –∫–ª—é—á –∞–∫—Ç–∏–≤–µ–Ω
3. –ú–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω

–õ–æ–≥–∏ –æ—à–∏–±–æ–∫ –≤ Django:
```python
LOGGING = {
    'handlers': {
        'file': {
            'filename': 'crypto_payments.log',
        },
    },
    'loggers': {
        'crypto_payments': {
            'level': 'DEBUG',
        },
    },
}
```
